<!DOCTYPE html>
<html>
<head>
  <meta name="baidu-site-verification" content="cns0EghbIQ" />
  <meta charset="utf-8">
  
  <title>mysql索引及查询优化 | 学海无涯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="mysql调优在做性能测试中经常会遇到一些sql的问题，其实做性能测试这几年遇到问题最多还是数据库这块，要么就是IO高要么就是cpu高，所以对数据的优化在性能测试过程中占据着很重要的地方。 常用SQL语句优化：  数据库(表)设计合理,我们的表设计要符合3NF,3范式(规范的模式),有时我们需要适当的逆范式 sql语句的优化(索引，常用小技巧.) 慢查询 （分析出现出问题的sql） Explai">
<meta name="keywords" content="index,mysqldumpslow,explain">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql索引及查询优化">
<meta property="og:url" content="https://jet-han.gitee.io/2017/05/29/mysql索引及查询优化/index.html">
<meta property="og:site_name" content="学海无涯">
<meta property="og:description" content="mysql调优在做性能测试中经常会遇到一些sql的问题，其实做性能测试这几年遇到问题最多还是数据库这块，要么就是IO高要么就是cpu高，所以对数据的优化在性能测试过程中占据着很重要的地方。 常用SQL语句优化：  数据库(表)设计合理,我们的表设计要符合3NF,3范式(规范的模式),有时我们需要适当的逆范式 sql语句的优化(索引，常用小技巧.) 慢查询 （分析出现出问题的sql） Explai">
<meta property="og:image" content="https://jet-han.gitee.io/img/icons/mysql.jpg">
<meta property="og:updated_time" content="2017-05-29T09:51:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mysql索引及查询优化">
<meta name="twitter:description" content="mysql调优在做性能测试中经常会遇到一些sql的问题，其实做性能测试这几年遇到问题最多还是数据库这块，要么就是IO高要么就是cpu高，所以对数据的优化在性能测试过程中占据着很重要的地方。 常用SQL语句优化：  数据库(表)设计合理,我们的表设计要符合3NF,3范式(规范的模式),有时我们需要适当的逆范式 sql语句的优化(索引，常用小技巧.) 慢查询 （分析出现出问题的sql） Explai">
<meta name="twitter:image" content="https://jet-han.gitee.io/img/icons/mysql.jpg">
  
    <link rel="alternative" href="/atom.xml" title="学海无涯" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
if ((!window.location.host.startsWith("localhost")) && (!window.location.host.startsWith("192.168.40")) && (window.location.protocol != "https:"))
        window.location = window.location.toString().replace(/^http:/, "https:");
  </script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/echarts@4.7.0/dist/echarts.common.min.js"></script>
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay">
<a href="https://github.com/jethan/blog" style="cursor: hand;z-index: 9999999!important" rel="external nofollow noopener noreferrer" target="_blank">
         <img style="position: absolute; top: 0; border: 0; transform: rotate(-90deg);" src="https://jet-han.gitee.io/img/icons/fork.png"
         alt="Fork me on GitHub">
</a>
</div>
<div class="intrude-less">
    <header id="header" class="inner">  
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/ali.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">Jet</a></h1>
        </hgroup>

        
        <p class="header-subtitle">技术博客</p>
        
        
        
        <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=225 height=86 src="//music.163.com/outchain/player?type=2&id=482792397&auto=0&height=66"></iframe>
        

        
            <form>
                <input type="text" class="st-default-search-input search" id="search" placeholder=" Search...">
            </form>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">首页</a></li>
                        
                            <li><a href="/archives">归档</a></li>
                        
                            <li><a href="/photos">相册</a></li>
                        
                            <li><a href="http://markdown.xiaoshujiang.com/">编辑器</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/jethan" title="github">github</a>
                            
                                <a class="fl zhihu" target="_blank" href="https://www.zhihu.com/people/jet-77-36" title="zhihu">zhihu</a>
                            
                                <a class="fl weibo" target="_blank" href="http://weibo.com/2146269010/profile?topnav=1&wvr=6&is_all=1" title="weibo">weibo</a>
                            
                                <a class="fl oschina" target="_blank" href="http://git.oschina.net/jet-han" title="oschina">oschina</a>
                            
                                <a class="fl twitter" target="_blank" href="https://twitter.com/fajie_han" title="twitter">twitter</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/" style="font-size: 20px;">==</a> <a href="/tags/AOF/" style="font-size: 10px;">AOF</a> <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/ArrayList/" style="font-size: 10px;">ArrayList</a> <a href="/tags/Arrays/" style="font-size: 10px;">Arrays</a> <a href="/tags/B-Tree索引/" style="font-size: 10px;">B-Tree索引</a> <a href="/tags/Bean的作用域/" style="font-size: 10px;">Bean的作用域</a> <a href="/tags/Bean的生命周期/" style="font-size: 10px;">Bean的生命周期</a> <a href="/tags/Collection/" style="font-size: 10px;">Collection</a> <a href="/tags/Collections/" style="font-size: 10px;">Collections</a> <a href="/tags/CountDownLatch/" style="font-size: 10px;">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size: 10px;">CyclicBarrier</a> <a href="/tags/Factory-Pattern/" style="font-size: 10px;">Factory Pattern</a> <a href="/tags/Generics/" style="font-size: 10px;">Generics</a> <a href="/tags/HEAP/" style="font-size: 10px;">HEAP</a> <a href="/tags/HashMap/" style="font-size: 10px;">HashMap</a> <a href="/tags/HashSet/" style="font-size: 10px;">HashSet</a> <a href="/tags/HashTable/" style="font-size: 10px;">HashTable</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/IOC/" style="font-size: 10px;">IOC</a> <a href="/tags/ISAM/" style="font-size: 10px;">ISAM</a> <a href="/tags/Innodb/" style="font-size: 10px;">Innodb</a> <a href="/tags/Intercepting-Filter-Pattern/" style="font-size: 10px;">Intercepting Filter Pattern</a> <a href="/tags/Iterator-Pattern/" style="font-size: 10px;">Iterator Pattern</a> <a href="/tags/LinkedHashMap/" style="font-size: 10px;">LinkedHashMap</a> <a href="/tags/LinkedList/" style="font-size: 10px;">LinkedList</a> <a href="/tags/MVC-Pattern/" style="font-size: 10px;">MVC Pattern</a> <a href="/tags/Map/" style="font-size: 10px;">Map</a> <a href="/tags/MapperScannerConfigurer/" style="font-size: 10px;">MapperScannerConfigurer</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/MyIsam/" style="font-size: 10px;">MyIsam</a> <a href="/tags/Proxy-Pattern/" style="font-size: 10px;">Proxy Pattern</a> <a href="/tags/RDB/" style="font-size: 10px;">RDB</a> <a href="/tags/ReentrantLock/" style="font-size: 10px;">ReentrantLock</a> <a href="/tags/Semaphore/" style="font-size: 10px;">Semaphore</a> <a href="/tags/Singleton-Pattern/" style="font-size: 10px;">Singleton Pattern</a> <a href="/tags/String/" style="font-size: 10px;">String</a> <a href="/tags/StringBuffer/" style="font-size: 10px;">StringBuffer</a> <a href="/tags/StringBuilder/" style="font-size: 10px;">StringBuilder</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 10px;">ThreadPoolExecutor</a> <a href="/tags/TreeMap/" style="font-size: 10px;">TreeMap</a> <a href="/tags/TreeSet/" style="font-size: 10px;">TreeSet</a> <a href="/tags/Vector/" style="font-size: 10px;">Vector</a> <a href="/tags/WeakHashMap/" style="font-size: 10px;">WeakHashMap</a> <a href="/tags/Wildcard/" style="font-size: 10px;">Wildcard</a> <a href="/tags/ambari/" style="font-size: 10px;">ambari</a> <a href="/tags/await/" style="font-size: 10px;">await</a> <a href="/tags/binlog/" style="font-size: 10px;">binlog</a> <a href="/tags/crontab/" style="font-size: 10px;">crontab</a> <a href="/tags/equals/" style="font-size: 20px;">equals</a> <a href="/tags/explain/" style="font-size: 10px;">explain</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/hashCode/" style="font-size: 10px;">hashCode</a> <a href="/tags/hashmap/" style="font-size: 10px;">hashmap</a> <a href="/tags/index/" style="font-size: 10px;">index</a> <a href="/tags/jdk8/" style="font-size: 10px;">jdk8</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/my-cnf配置详解/" style="font-size: 10px;">my.cnf配置详解</a> <a href="/tags/mysqldump/" style="font-size: 10px;">mysqldump</a> <a href="/tags/mysqldumpslow/" style="font-size: 10px;">mysqldumpslow</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/notify/" style="font-size: 10px;">notify</a> <a href="/tags/notifyAll/" style="font-size: 10px;">notifyAll</a> <a href="/tags/quartz/" style="font-size: 10px;">quartz</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/runnable/" style="font-size: 10px;">runnable</a> <a href="/tags/signal/" style="font-size: 10px;">signal</a> <a href="/tags/signalAll/" style="font-size: 10px;">signalAll</a> <a href="/tags/solr/" style="font-size: 10px;">solr</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/spring单例模式/" style="font-size: 10px;">spring单例模式</a> <a href="/tags/spring线程安全/" style="font-size: 10px;">spring线程安全</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/synchronized/" style="font-size: 10px;">synchronized</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/volatile/" style="font-size: 10px;">volatile</a> <a href="/tags/vpn/" style="font-size: 10px;">vpn</a> <a href="/tags/wait/" style="font-size: 10px;">wait</a> <a href="/tags/web-xml加载顺序/" style="font-size: 10px;">web.xml加载顺序</a> <a href="/tags/主从/" style="font-size: 10px;">主从</a> <a href="/tags/主从备份/" style="font-size: 10px;">主从备份</a> <a href="/tags/乐观锁/" style="font-size: 10px;">乐观锁</a> <a href="/tags/事务传播属性/" style="font-size: 10px;">事务传播属性</a> <a href="/tags/事务隔离级别/" style="font-size: 10px;">事务隔离级别</a> <a href="/tags/二分/" style="font-size: 10px;">二分</a> <a href="/tags/冒泡/" style="font-size: 10px;">冒泡</a> <a href="/tags/堆/" style="font-size: 10px;">堆</a> <a href="/tags/容器/" style="font-size: 10px;">容器</a> <a href="/tags/希尔/" style="font-size: 10px;">希尔</a> <a href="/tags/常量池/" style="font-size: 10px;">常量池</a> <a href="/tags/快速/" style="font-size: 10px;">快速</a> <a href="/tags/性能调优/" style="font-size: 10px;">性能调优</a> <a href="/tags/悲观锁/" style="font-size: 10px;">悲观锁</a> <a href="/tags/持久化/" style="font-size: 10px;">持久化</a> <a href="/tags/插入/" style="font-size: 10px;">插入</a> <a href="/tags/方法区/" style="font-size: 10px;">方法区</a> <a href="/tags/本地方法栈/" style="font-size: 10px;">本地方法栈</a> <a href="/tags/泛型/" style="font-size: 10px;">泛型</a> <a href="/tags/程序计数器/" style="font-size: 10px;">程序计数器</a> <a href="/tags/线程池/" style="font-size: 10px;">线程池</a> <a href="/tags/虚拟机栈/" style="font-size: 10px;">虚拟机栈</a> <a href="/tags/语句执行/" style="font-size: 10px;">语句执行</a> <a href="/tags/迭代/" style="font-size: 10px;">迭代</a> <a href="/tags/选择/" style="font-size: 10px;">选择</a> <a href="/tags/递归/" style="font-size: 10px;">递归</a> <a href="/tags/隔离级别/" style="font-size: 10px;">隔离级别</a> <a href="/tags/面试技巧/" style="font-size: 10px;">面试技巧</a> <a href="/tags/面试题/" style="font-size: 10px;">面试题</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://jethan.bid/">学海无涯</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">纯海迷、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">Jet</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/ali.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">Jet</a></h1>
            </hgroup>
            
            <p class="header-subtitle">技术博客</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">首页</a></li>
                
                    <li><a href="/archives">归档</a></li>
                
                    <li><a href="/photos">相册</a></li>
                
                    <li><a href="http://markdown.xiaoshujiang.com/">编辑器</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/jethan" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jet-77-36" title="zhihu">zhihu</a>
                    
                        <a class="weibo" target="_blank" href="http://weibo.com/2146269010/profile?topnav=1&wvr=6&is_all=1" title="weibo">weibo</a>
                    
                        <a class="oschina" target="_blank" href="http://git.oschina.net/jet-han" title="oschina">oschina</a>
                    
                        <a class="twitter" target="_blank" href="https://twitter.com/fajie_han" title="twitter">twitter</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-mysql索引及查询优化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/29/mysql索引及查询优化/" class="article-date">
      <time datetime="2017-05-29T09:51:19.000Z" itemprop="datePublished">2017-05-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      mysql索引及查询优化
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/database/">database</a><a class="article-category-link" href="/categories/database/mysql/">mysql</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/explain/">explain</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/index/">index</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysqldumpslow/">mysqldumpslow</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><img src="https://jet-han.gitee.io/img/icons/mysql.jpg" alt="mysql" title="mysql"></p>
<h1 id="mysql调优"><a href="#mysql调优" class="headerlink" title="mysql调优"></a>mysql调优</h1><p>在做性能测试中经常会遇到一些sql的问题，其实做性能测试这几年遇到问题最多还是数据库这块，要么就是IO高要么就是cpu高，所以对数据的优化在性能测试过程中占据着很重要的地方。</p>
<p><strong>常用SQL语句优化：</strong></p>
<ul>
<li>数据库(表)设计合理,我们的表设计要符合3NF,3范式(规范的模式),有时我们需要适当的逆范式</li>
<li>sql语句的优化(索引，常用小技巧.)<ul>
<li>慢查询 （分析出现出问题的sql）</li>
<li>Explain （显示了mysql如何使用索引来处理select语句以及连接表。可以帮助选择更好的索引和写出更优化的查询语句）</li>
<li>Profile（查询到 SQL 会执行多少时间, 并看出 CPU/Memory 使用量, 执行过程中 Systemlock, Table lock 花多少时间等等.）</li>
</ul>
</li>
<li>数据的配置(缓存设大)</li>
<li>适当硬件配置和操作系统 (读写分离.)</li>
</ul>
<p><strong>数据的3NF(normal forms)</strong></p>
<ul>
<li><strong>1NF :</strong>就是具有原子性，不可分割。简单来说就是无重复的行，并且列不可再分(只要使用的是关系性数据库，就自动符合)；  </li>
<li><strong>2NF: </strong>在满足1NF 的基础上，我们考虑是否满足2NF: 只要表的记录满足唯一性,也是说,你的同一张表，不可能出现完全相同的记录, 一般说我们在表中设计一个主键即可；  </li>
<li><strong>3NF: </strong>在满足2NF 的基础上，我们考虑是否满足3NF：即我们的字段信息可以通过关联的关系，派生即可.(通常我们通过外键来处理)。</li>
</ul>
<p><strong>逆范式（为什么需要逆范式:）:</strong> </p>
<p>逆范式化指的是通过<strong>增加冗余或重复的数据来提高数据库的读性能</strong>。<br>例如：在user_role用户-角色中间表增加字段role_name(user表通过role_id与role表关联查询role_name，直接在user表中添加冗余字段role_name)。<br>逆范式化可以减少关联查询时，join表的次数。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">编号</th>
<th style="text-align:center">姓名</th>
<th style="text-align:center">出生日期</th>
<th style="text-align:center">生肖</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">张三</td>
<td style="text-align:center">1980-01-02</td>
<td style="text-align:center">猴</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">李四</td>
<td style="text-align:center">1983-04-02</td>
<td style="text-align:center">牛</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">王五</td>
<td style="text-align:center">1988-11-02</td>
<td style="text-align:center">牛</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>生肖表　</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">生肖编号</th>
<th style="text-align:center">生肖名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">猴</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">牛</td>
</tr>
</tbody>
</table>
</div>
<p><strong>【说明】</strong>生肖其实是和时间有关系了，可以通过生日来确定生肖是什么，所以这里的生肖完全可以忽略不计，这样设计是为了减轻数据库的计算压力，所以才保留此字段的，也就是前面提到的<strong>“冗余字段”，逆范式</strong>。所以由此可以推出<strong>3NF是完全可以违反的</strong>。</p>
<p><strong>总结：</strong></p>
<ul>
<li>NF1 行不可重复，列不可再分 （必须满足)  </li>
<li>NF2 非主键列必须依赖于主键列  （必须满足）  </li>
<li>NF3 非主键列之间必须相互独立 （NF3可以不满足 ）  </li>
</ul>
<a id="more"></a>
<h2 id="sql语句分类"><a href="#sql语句分类" class="headerlink" title="sql语句分类"></a>sql语句分类</h2><ul>
<li>ddl(数据定义语言)   [create truncate alter drop]</li>
<li>dml(数据操作语言)   [insert delete upate select]</li>
<li>dtl(数据事务语句)   [commit rollback savepoint]</li>
<li>dcl(数据控制语句)   [grant revoke]</li>
</ul>
<h2 id="优化查询分析工具"><a href="#优化查询分析工具" class="headerlink" title="优化查询分析工具"></a>优化查询分析工具</h2><h3 id="查询数据库性能"><a href="#查询数据库性能" class="headerlink" title="查询数据库性能"></a>查询数据库性能</h3><ul>
<li><code>show status like &quot;connections&quot;;</code> # 连接服务器次数  </li>
<li><code>show status like &quot;uptime&quot;;</code>   # 服务器上线时间  </li>
<li><code>show status like &quot;slow_queries&quot;;</code>  #慢查询次数  </li>
<li><code>show status like &quot;com_select&quot;;</code> #查询操作次数  </li>
<li><code>show status like &quot;com_insert&quot;;</code> #插入次数  </li>
<li><code>show status like &quot;com_delete&quot;;</code> #删除次数  </li>
<li><code>show variables like &quot;long_query_time&quot;;</code> #慢查询时间  </li>
</ul>
<h3 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h3><p>详见<a href="https://jet-han.gitee.io/2017/05/29/mysql%E7%B4%A2%E5%BC%95%E5%8F%8A%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/#%E5%BC%80%E5%90%AF%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97">慢查询</a></p>
<h3 id="分析查询语句"><a href="#分析查询语句" class="headerlink" title="分析查询语句"></a>分析查询语句</h3><p>详见<a href="https://jet-han.gitee.io/2017/05/29/mysql%E7%B4%A2%E5%BC%95%E5%8F%8A%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/#explain%E5%88%86%E6%9E%90%E6%9F%A5%E8%AF%A2">explain分析查询</a></p>
<h3 id="分析检测优化表"><a href="#分析检测优化表" class="headerlink" title="分析检测优化表"></a>分析检测优化表</h3><h4 id="Analyze-Table"><a href="#Analyze-Table" class="headerlink" title="Analyze Table"></a>Analyze Table</h4><p>MySQL 的<code>Optimizer</code>（优化元件）在优化SQL语句时，首先需要收集一些相关信息，其中就包括表的cardinality（可以翻译为“散列程度”），它表示某个索引对应的列包含多少个不同的值——如果<code>cardinality</code>大大少于数据的实际散列程度，那么索引就基本失效了。<br>我们可以使用SHOW INDEX语句来查看索引的散列程度：</p>
<pre><code>SHOW INDEX FROM PLAYERS;

TABLE   KEY_NAME COLUMN_NAME CARDINALITY
------- -------- ----------- -----------
PLAYERS PRIMARY PLAYERNO             14
</code></pre><p>因为此时PLAYER表中不同的PLAYERNO数量远远多于14，索引基本失效。<br>下面我们通过<code>Analyze Table</code>语句来修复索引：</p>
<pre><code>ANALYZE TABLE PLAYERS;
SHOW INDEX FROM PLAYERS;
结果是：
TABLE   KEY_NAME COLUMN_NAME CARDINALITY
------- -------- ----------- -----------
PLAYERS PRIMARY PLAYERNO           1000
</code></pre><p>此时索引已经修复，查询效率大大提高。</p>
<p>需要注意的是，如果开启了<code>binlog</code>，那么<code>Analyze Table</code>的结果也会写入<code>binlog</code>，我们可以在<code>analyze</code>和<code>table</code>之间添加关键字<code>local</code>取消写入。</p>
<h4 id="Checksum-Table"><a href="#Checksum-Table" class="headerlink" title="Checksum Table"></a>Checksum Table</h4><p>数据在传输时，可能会发生变化，也有可能因为其它原因损坏，为了保证数据的一致，我们可以计算checksum（校验值）。<br>使用<code>MyISAM引擎</code>的表会把checksum存储起来，称为<code>live checksum</code>，当数据发生变化时，<code>checksum</code>会相应变化。<br>在执行<code>Checksum Table</code>时，可以在最后指定选项<code>qiuck</code>或是<code>extended</code>；<code>quick</code>表示返回存储的<code>checksum</code>值，而<code>extended</code>会重新计算<code>checksum</code>，如果没有指定选项，则默认使用<code>extended</code>。</p>
<h4 id="Optimize-Table"><a href="#Optimize-Table" class="headerlink" title="Optimize Table"></a>Optimize Table</h4><p>经常更新数据的磁盘需要整理碎片，数据库也是这样，<code>Optimize Table</code>语句对<code>MyISAM和InnoDB</code>类型的表都有效。<br>如果表经常更新，就应当定期运行<code>Optimize Table</code>语句，保证效率。<br>与<code>Analyze Table</code>一样，<code>Optimize Table</code>也可以使用<code>local</code>来<code>取消写入binlog</code>。</p>
<h4 id="Check-Table"><a href="#Check-Table" class="headerlink" title="Check Table"></a>Check Table</h4><p>数据库经常可能遇到错误，譬如数据写入磁盘时发生错误，或是索引没有同步更新，或是数据库未关闭MySQL就停止了。<br>遇到这些情况，数据就可能发生错误：<br>Incorrect key file for table: ‘ ‘. Try to repair it.<br>此时，我们可以使用Check Table语句来检查表及其对应的索引。<br>譬如我们运行</p>
<pre><code>CHECK TABLE PLAYERS;
</code></pre><p>结果是</p>
<pre><code>TABLE          OP    MSG_TYPE MSG_TEXT
-------------- ----- -------- --------
TENNIS.PLAYERS check status   OK
</code></pre><p>MySQL会保存表最近一次检查的时间，每次运行check table都会存储这些信息：</p>
<p>执行 </p>
<pre><code>SELECT    TABLE_NAME, CHECK_TIME
FROM      INFORMATION_SCHEMA.TABLES
WHERE     TABLE_NAME = &#39;PLAYERS&#39;
AND       TABLE_SCHEMA = &#39;TENNIS&#39;;  /*TENNIS是数据库名*/
</code></pre><p>结果是</p>
<pre><code>TABLE_NAME   CHECK_TIME
----------   -------------------
PLAYERS      2006-08-21 16:44:25
</code></pre><p><code>Check Table</code>还可以指定其它选项：</p>
<ul>
<li>UPGRADE：用来测试在更早版本的MySQL中建立的表是否与当前版本兼容。</li>
<li>QUICK：速度最快的选项，在检查各列的数据时，不会检查链接（link）的正确与否，如果没有遇到什么问题，可以使用这个选项。</li>
<li>FAST：只检查表是否正常关闭，如果在系统掉电之后没有遇到严重问题，可以使用这个选项。</li>
<li>CHANGED：只检查上次检查时间之后更新的数据。</li>
<li>MEDIUM：默认的选项，会检查索引文件和数据文件之间的链接正确性。</li>
<li>EXTENDED：最慢的选项，会进行全面的检查。</li>
</ul>
<h4 id="Repair-Table"><a href="#Repair-Table" class="headerlink" title="Repair Table"></a>Repair Table</h4><p>用于修复表，只对<code>MyISAM和ARCHIVE</code>类型的表有效。<br>这条语句同样可以指定选项：</p>
<ul>
<li>QUICK：最快的选项，只修复索引树。</li>
<li>EXTENDED：最慢的选项，需要逐行重建索引。</li>
<li>USE_FRM：只有当MYI文件丢失时才使用这个选项，全面重建整个索引。</li>
</ul>
<p>与<code>Analyze Table</code>一样，<code>Repair Table</code>也可以使用<code>local</code>来取消写入<code>binlog</code>。</p>
<h4 id="查询高速缓存"><a href="#查询高速缓存" class="headerlink" title="查询高速缓存"></a>查询高速缓存</h4><pre><code>show variables like ‘%query_cache%’;
</code></pre><h4 id="查询状态show-full-processlist"><a href="#查询状态show-full-processlist" class="headerlink" title="查询状态show full processlist"></a>查询状态show full processlist</h4><p>状态有<code>sleep、query、locked、analyzing and statistics、coping to tmp table、Sorting result、sending data</code></p>
<h2 id="开启慢查询日志"><a href="#开启慢查询日志" class="headerlink" title="开启慢查询日志"></a>开启慢查询日志</h2><p>以下所有配置是在<code>5.1.73</code>版本中</p>
<h3 id="设置慢查询时间"><a href="#设置慢查询时间" class="headerlink" title="设置慢查询时间"></a>设置慢查询时间</h3><p><code>long_query_time</code>是用来定义慢于多少秒的才算“慢查询”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show variables like &apos;long_query_time%&apos;;</div><div class="line">+-----------------+----------+</div><div class="line">| Variable_name   | Value    |</div><div class="line">+-----------------+----------+</div><div class="line">| long_query_time | 1.000000 |</div><div class="line">+-----------------+----------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>设置为1, 也就是执行时间超过1秒的都算慢查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; set global long_query_time = 1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<!-- more -->
<h3 id="查看是否打开慢查询日志记录"><a href="#查看是否打开慢查询日志记录" class="headerlink" title="查看是否打开慢查询日志记录"></a>查看是否打开慢查询日志记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show variables like &apos;slow%&apos;;</div><div class="line">+---------------------+---------------------------------+</div><div class="line">| Variable_name       | Value                           |</div><div class="line">+---------------------+---------------------------------+</div><div class="line">| slow_launch_time    | 2                               |</div><div class="line">| slow_query_log      | ON                              |</div><div class="line">| slow_query_log_file | /home/logs/slow.log |</div><div class="line">+---------------------+---------------------------------+</div><div class="line">3 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="打开日志记录"><a href="#打开日志记录" class="headerlink" title="打开日志记录"></a>打开日志记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; set global slow_query_log = on;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>一旦<code>slow_query_log</code>变量被设置为<code>ON</code>，<code>mysql</code>会立即开始记录。<br><code>/etc/my.cnf</code> 里面可以设置上面MYSQL全局变量的初始值。</p>
<p>在<code>[mysqld]</code>下添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">long_query_time=1 #执行时间超过1s的都记录日志</div><div class="line">slow_query_log = 1 #开启慢查询</div><div class="line">slow_query_log_file=/home/logs/slow.log</div></pre></td></tr></table></figure>
<p>使用<code>select sleep(1)</code>跑一条慢查询数据查看日志是否记录</p>
<p>【注意】<br>注意这里文件夹权限问题，否则会报错<code>/usr/libexec/mysqld: File &#39;/home/jet/logs/slow.log&#39; not found (Errcode: 13)</code></p>
<p>这里是因为jet目录所属用户和用户组是jet不是mysql导致，同时logs文件夹必须所属mysql用户和用户组；<br>home文件夹当然是属于root用户的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /home</div><div class="line">sudo chown mysql.mysql logs</div></pre></td></tr></table></figure>
<p>下面测试直接写入到<code>/home/test.txt</code>同样会报权限错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select user from user into outfile &apos;/home/test.txt&apos;;</div><div class="line">ERROR 1 (HY000): Can&apos;t create/write to file &apos;/home/test.txt&apos; (Errcode: 13)</div><div class="line">mysql&gt; select user from user into outfile &apos;/home/logs/test.txt&apos;;</div><div class="line">Query OK, 8 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>如果写到<code>/home/logs</code>文件夹下，则通过:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[jet@jet logs]$ pwd</div><div class="line">/home/logs</div><div class="line">[jet@jet logs]$ ll</div><div class="line">total 8</div><div class="line">-rw-rw---- 1 mysql mysql 174 Sep  7 17:22 slow.log</div><div class="line">-rw-rw-rw- 1 mysql mysql  31 Sep  7 17:27 test.txt</div><div class="line">[jet@jet logs]$ sudo more slow.log </div><div class="line">/usr/libexec/mysqld, Version: 5.1.73-log (Source distribution). started with:</div><div class="line">Tcp port: 0  Unix socket: /var/lib/mysql/mysql.sock</div><div class="line">Time                 Id Command    Argument</div><div class="line">[jet@jet logs]$ sudo more test.txt </div><div class="line">root</div><div class="line">jet</div><div class="line">root</div><div class="line">root</div><div class="line"></div><div class="line">root</div><div class="line"></div><div class="line">root</div></pre></td></tr></table></figure>
<p>还有一种情况是，如果文件夹权限都没问题，依然报<code>(Errcode: 13)</code>,那么可能是<code>selinux</code><br>关闭<code>selinux</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">setenforce 0</div></pre></td></tr></table></figure>
<p>或者修改配置文件<code>sudo vim /etc/selinux/config</code>将<code>SELINUX=enforcing</code>改为<code>SELINUX=disabled</code></p>
<h3 id="mysqldumpslow-mysqlsla分析日志"><a href="#mysqldumpslow-mysqlsla分析日志" class="headerlink" title="mysqldumpslow/mysqlsla分析日志"></a>mysqldumpslow/mysqlsla分析日志</h3><h4 id="mysqldumpslow"><a href="#mysqldumpslow" class="headerlink" title="mysqldumpslow"></a>mysqldumpslow</h4><p><code>mysqldumpslow -s c -t 10 /home/logs/slow.log</code>  </p>
<p>这会输出记录次数最多的10条SQL语句，其中：  </p>
<p><code>-s</code>, 是表示按照何种方式排序，<code>c</code>、<code>t</code>、<code>l</code>、<code>r</code>分别是按照记录次数、时间、查询时间、返回的记录数来排序，<code>ac</code>、<code>at</code>、<code>al</code>、<code>ar</code>，表示相应的倒叙；<br><code>-t</code>, 是top n的意思，即为返回前面多少条的数据；<br><code>-g</code>, 后边可以写一个正则匹配模式，大小写不敏感的；<br>如下：</p>
<p>得到返回记录集最多的10个查询。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldumpslow -s r -t 10 /home/logs/slow.log</div></pre></td></tr></table></figure></p>
<p>得到按照时间排序的前10条里面含有左连接的查询语句。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldumpslow -s t -t 10 -g “left join” /home/logs/slow.log</div></pre></td></tr></table></figure></p>
<p>使用<code>mysqldumpslow</code>命令可以非常明确的得到各种我们需要的查询语句，对MySQL查询语句的监控、分析、优化是MySQL优化的第一步，也是非常重要的一步。</p>
<h4 id="mysqlsla慢查询分析工具"><a href="#mysqlsla慢查询分析工具" class="headerlink" title="mysqlsla慢查询分析工具"></a>mysqlsla慢查询分析工具</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">wget http: //hackmysql .com /scripts/mysqlsla-2 .03. tar .gz</div><div class="line">tar xzf mysqlsla-2.03. tar .gz</div><div class="line">cd mysqlsla-2.03</div><div class="line"> </div><div class="line">perl Makefile.PL</div><div class="line">make</div><div class="line">make install</div><div class="line">#安装信息</div><div class="line">#Installing /usr/local/share/perl5/mysqlsla.pm</div><div class="line">#Installing /usr/local/share/man/man3/mysqlsla.3pm</div><div class="line">#Installing /usr/local/bin/mysqlsla</div><div class="line">#Appending installation info to /usr/lib/perl5/perllocal.pod</div><div class="line"> </div><div class="line">file /usr/local/bin/mysqlsla</div><div class="line">#其实是一个perl脚本</div><div class="line">#/usr/local/bin/mysqlsla: a /usr/bin/perl -w script text executable</div></pre></td></tr></table></figure>
<p><strong>慢查询统计</strong><br>统计出现次数最多的前10条慢查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqlsla -lt slow /home/logs/slow.log - top 10 - sort c_sum &gt; top10_count_sum.log</div></pre></td></tr></table></figure></p>
<p>统计执行时间的总和前10条慢查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqlsla -lt slow /home/logs/slow.log - top 10 - sort t_sum &gt; top10_time_sum.log</div></pre></td></tr></table></figure></p>
<p>统计平均执行时间最长的前10条慢查询(常用)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqlsla -lt slow /home/logs/slow.log - top 10 - sort t_avg &gt; top10_time_avg.log</div></pre></td></tr></table></figure></p>
<h2 id="explain分析查询"><a href="#explain分析查询" class="headerlink" title="explain分析查询"></a>explain分析查询</h2><p>使用 <code>EXPLAIN</code> 关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的SQL语句的。这可以帮你分析你的查询语句或是表结构的性能瓶颈。通过<code>explain</code>命令可以得到:<br>– 表的读取顺序<br>– 数据读取操作的操作类型<br>– 哪些索引可以使用<br>– 哪些索引被实际使用<br>– 表之间的引用<br>– 每张表有多少行被优化器查询</p>
<p><strong>EXPLAIN字段解释：</strong></p>
<p><strong>Table</strong>：显示这一行的数据是关于哪张表的</p>
<p><strong>possible_keys</strong>：显示可能应用在这张表中的索引。如果为空，没有可能的索引。可以为相关的域从WHERE语句中选择一个合适的语句</p>
<p><strong>key</strong>：实际使用的索引。如果为NULL，则没有使用索引。MYSQL很少会选择优化不足的索引，此时可以在SELECT语句中使用<code>USE INDEX</code>（index）来强制使用一个索引或者用<code>IGNORE INDEX</code>（index）来强制忽略索引</p>
<p><strong>key_len</strong>：使用的索引的长度。在不损失精确性的情况下，长度越短越好</p>
<p><strong>ref</strong>：显示索引的哪一列被使用了，如果可能的话，是一个常数</p>
<p><strong>rows</strong>：MySQL认为必须检索的用来返回请求数据的行数</p>
<p><strong>type</strong>：这是最重要的字段之一，显示查询使用了何种类型。从最好到最差的连接类型为system、const、eq_reg、ref、range、index和ALL</p>
<ol>
<li><p><strong>system、const</strong>：可以将查询的变量转为常量. 如id=1; id为 主键或唯一键.</p>
</li>
<li><p><strong>eq_ref</strong>：访问索引,返回某单一行的数据.(通常在联接时出现，查询使用的索引为主键或惟一键)</p>
</li>
<li><p><strong>ref</strong>：访问索引,返回某个值的数据.(可以返回多行) 通常使用=时发生</p>
</li>
<li><p><strong>range</strong>：这个连接类型使用索引返回一个范围中的行，比如使用&gt;或&lt;查找东西，并且该字段上建有索引时发生的情况(注:不一定好于index)</p>
</li>
<li><p><strong>index</strong>：以索引的顺序进行全表扫描，优点是不用排序,缺点是还要全表扫描</p>
</li>
<li><p><strong>ALL</strong>：全表扫描，应该尽量避免</p>
</li>
</ol>
<p><strong>Extra</strong>：关于MYSQL如何解析查询的额外信息，主要有以下几种</p>
<ol>
<li><p><strong>using index</strong>：只用到索引,可以避免访问表.</p>
</li>
<li><p><strong>using where</strong>：使用到where来过虑数据. 不是所有的where clause都要显示using where. 如以=方式访问索引.</p>
</li>
<li><p><strong>using tmporary</strong>：用到临时表，看到这个的时候，查询需要优化了。这里，MYSQL需要创建一个临时表来存储结果，这通常发生在对不同的列集进行<code>ORDER BY</code>上，而不是GROUP BY上</p>
</li>
<li><p><strong>using filesort</strong>：用到额外的排序. (当使用order by v1,而没用到索引时,就会使用额外的排序)</p>
</li>
<li><p><strong>range checked for eache record(index map:N)</strong>：没有好的索引.</p>
</li>
<li><p><strong>Distinct</strong>  (一旦MYSQL找到了与行相联合匹配的行，就不再搜索了（</p>
</li>
<li><p><strong>Not exists</strong> （MYSQL优化了LEFT JOIN，一旦它找到了匹配LEFT JOIN标准的行， 就不再搜索了）</p>
</li>
<li><p><strong>Where used</strong> (使用了WHERE从句来限制哪些行将与下一张表匹配或者是返回给用户。如果不想返回表中的全部行，并且连接类型ALL或index，这就会发生，或者是查询有问题)</p>
</li>
</ol>
<h2 id="索引及查询优化"><a href="#索引及查询优化" class="headerlink" title="索引及查询优化"></a>索引及查询优化</h2><h3 id="索引的类型"><a href="#索引的类型" class="headerlink" title="索引的类型"></a>索引的类型</h3><p>  其实按照定义，除了聚集索引以外的索引都是非聚集索引，只是人们想细分一下非聚集索引，分成普通索引，唯一索引，全文索引。聚集索引的叶子节点就是对应的数据节点（MySQL的MyISAM除外，此存储引擎的聚集索引和非聚集索引只多了个唯一约束，其他没什么区别），可以直接获取到对应的全部列的数据，而非聚集索引在索引没有覆盖到对应的列的时候需要进行二次查询， </p>
<p><strong> 比较</strong></p>
<ul>
<li>聚集索引就字典的首字母查询</li>
<li>非聚集索引就是字典的偏旁部首查询</li>
<li>聚集索引一个表只能有一个，而非聚集索引一个表可以存在多个</li>
<li>聚集索引存储记录是物理上连续存在，而非聚集索引是逻辑上的连续，物理存储并不连续</li>
</ul>
<p><strong>如何创建</strong></p>
<p>InnoDB按照主键进行聚集，如果没有定义主键，InnoDB会试着使用唯一的非空索引来代替。如果没有这种索引，InnoDB就会定义隐藏的主键然后在上面进行聚集。 </p>
<p>所以，对于 聚集索引 来说，你创建主键的时候，自动就创建了主键的聚集索引。 </p>
<p>而普通索引（非聚集索引）的语法，大多数数据库都是通用的 </p>
<h4 id="聚集索引"><a href="#聚集索引" class="headerlink" title="聚集索引"></a>聚集索引</h4><p>　　该索引中键值的逻辑顺序决定了表中相应行的物理顺序。<br>　　聚集索引确定表中数据的物理顺序。聚集索引类似于电话簿，后者按姓氏排列数据。由于聚集索引规定数据在表中的物理存储顺序，因此一个表只能包含一个聚集索引。但该索引可以包含多个列（组合索引），就像电话簿按姓氏和名字进行组织一样。 </p>
<ul>
<li><strong>主键索引</strong>：主键是一种唯一索引，但必须指定为<code>PRIMARY KEY</code>。</li>
</ul>
<h4 id="非聚集索引"><a href="#非聚集索引" class="headerlink" title="非聚集索引"></a>非聚集索引</h4><p>　　该索引中索引的逻辑顺序与磁盘上行的物理存储顺序不同。<br>　　索引是通过二叉树的数据结构来描述的，我们可以这么理解聚簇索引：索引的叶节点就是数据节点。而非聚簇索引的叶节点仍然是索引节点，只不过有一个指针指向对应的数据块。</p>
<ul>
<li><strong>普通索引</strong>：这是最基本的索引类型，没唯一性之类的限制。</li>
<li><strong>唯一索引</strong>：和普通索引基本相同，但所有的索引列值保持唯一性。</li>
<li><strong>全文索引</strong>：MYSQL从3.23.23开始支持全文索引和全文检索。在MYSQL中，全文索引的索引类型为<code>FULLTEXT</code>。全文索引可以在<code>VARCHAR</code>或者<code>TEXT</code>类型的列上创建。</li>
</ul>
<p>大多数MySQL索引(PRIMARY KEY、UNIQUE、INDEX和FULLTEXT)使用平衡树中存储。空间列类型的索引使用R-树，MEMORY表支持hash索引。</p>
<p><strong>单列索引和多列索引（复合索引）</strong></p>
<p>索引可以是单列索引，也可以是多列索引。对相关的列使用索引是提高SELECT操作性能的最佳途径之一。</p>
<p><strong>多列索引：</strong></p>
<p>MySQL可以为多个列创建索引。一个索引可以包括15个列。对于某些列类型，可以索引列的左前缀，列的顺序非常重要。</p>
<p>多列索引可以视为包含通过连接索引列的值而创建的值的排序的数组。一般来说，即使是限制最严格的单列索引，它的限制能力也远远低于多列索引。</p>
<p><strong>最左前缀：</strong></p>
<p>多列索引有一个特点，即最左前缀（<code>Leftmost Prefixing</code>）。假如有一个多列索引为<code>key(firstname lastname age)</code>，当搜索条件是以下各种列的组合和顺序时，MySQL将使用该多列索引：</p>
<p><code>firstname，lastname，age</code></p>
<p><code>firstname，lastname</code></p>
<p><code>firstname</code></p>
<p>也就是说，相当于还建立了<code>key(firstname lastname)</code>和<code>key(firstname)</code>。</p>
<p><strong>索引主要用于下面的操作：</strong></p>
<ol>
<li><p>快速找出匹配一个<code>WHERE</code>子句的行。</p>
</li>
<li><p>删除行。当执行联接时，从其它表检索行。</p>
</li>
<li><p>对具体有索引的列<code>key_col</code>找出<code>MAX()</code>或<code>MIN()</code>值。由预处理器进行优化，检查是否对索引中在<code>key_col</code>之前发生所有关键字元素使用了<code>WHERE key_part_# = constant</code>。在这种情况下，MySQL为每个<code>MIN()</code>或<code>MAX()</code>表达式执行一次关键字查找，并用常数替换它。如果所有表达式替换为常量，查询立即返回。例如：</p>
</li>
</ol>
<p><code>SELECT MIN(key2), MAX (key2) FROM tb WHERE key1=10;</code></p>
<ol>
<li><p>如果对一个可用关键字的最左面的前缀进行了排序或分组(例如，<code>ORDER BY key_part_1,key_part_2</code>)，排序或分组一个表。如果所有关键字元素后面有<code>DESC</code>，关键字以倒序被读取。</p>
</li>
<li><p>在一些情况中，可以对一个查询进行优化以便不用查询数据行即可以检索值。如果查询只使用来自某个表的数字型并且构成某些关键字的最左面前缀的列，为了更快，可以从索引树检索出值。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SELECT key_part3 FROM tb WHERE key_part1=1</div></pre></td></tr></table></figure>
<p>有时MySQL不使用索引，即使有可用的索引。一种情形是当优化器估计到使用索引将需要MySQL访问表中的大部分行时。(在这种情况下，表扫描可能会更快些）。然而，如果此类查询使用<code>LIMIT</code>只搜索部分行，MySQL则使用索引，因为它可以更快地找到几行并在结果中返回。</p>
<p><strong>合理的建立索引</strong></p>
<p>(1) 越小的数据类型通常更好：越小的数据类型通常在磁盘、内存和CPU缓存中都需要更少的空间，处理起来更快。</p>
<p>(2) 简单的数据类型更好：<font color="#e07878">整型数据比起字符，处理开销更小</font>，因为字符串的比较更复杂。在MySQL中，<font color="#e07878">应该用内置的日期和时间数据类型，而不是用字符串来存储时间；以及用整型数据类型存储IP地址。</font></p>
<p>(3) 尽量避免<code>NUL</code>L：应该指定列为<code>NOT NULL</code>，除非你想存储<code>NULL</code>。在MySQL中，含有<code>NULL</code>的列很难进行查询优化，因为它们使得索引、索引的统计信息以及比较运算更加复杂。<font color="#e07878">应该用0、一个特殊的值或者一个空串代替<code>NULL</code></font></p>
<p>(4) 索引并不是越多越好，要根据查询有针对性的创建，考虑在WHERE和ORDER BY命令上涉及的列建立索引，可根据EXPLAIN来查看是否用了索引还是全表扫描</p>
<p>(5) 应尽量避免在<code>WHERE</code>子句中对字段进行NULL值判断，否则将导致引擎放弃使用索引而进行全表扫描如：<code>select id from t where num is null</code>可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：<code>select id from t where num = 0</code></p>
<p>(6) 值分布很稀少的字段不适合建索引，例如”性别”这种只有两三个值的字段</p>
<p>(7) 字符字段只建前缀索引</p>
<p>(8) 并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引，如一表中有字段 sex，male、female几乎各一半，那么即使在sex上建了索引也对查询效率起不了作用。</p>
<p>(9) 应尽可能的避免更新 <code>clustered</code> 索引数据列，因为 clustered 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 clustered 索引数据列，那么需要考虑是否应将该索引建为 clustered 索引。</p>
<p>(10) 使用聚集索引的查询效率要比非聚集索引的效率要高，但是如果需要频繁去改变聚集索引的值，写入性能并不高，因为需要移动对应数据的物理位置。</p>
<p>(11) 非聚集索引在查询的时候可以的话就避免二次查询，这样性能会大幅提升。</p>
<p>(12) 不是所有的表都适合建立索引，只有数据量大表才适合建立索引，且建立在选择性高的列上面性能会更好。</p>
<p><strong>字段</strong></p>
<ol>
<li><p>尽量使用TINYINT、SMALLINT、MEDIUM_INT作为整数类型而非INT，如果非负则加上UNSIGNED</p>
</li>
<li><p>VARCHAR的长度只分配真正需要的空间</p>
</li>
<li><p>使用枚举或整数代替字符串类型</p>
</li>
<li><p>尽量使用TIMESTAMP而非DATETIME，</p>
</li>
<li><p>单表不要有太多字段，建议在20以内</p>
</li>
<li><p>避免使用NULL字段，很难查询优化且占用额外索引空间</p>
</li>
<li><p>用整型来存IP</p>
</li>
</ol>
<p><strong>SQL语句注意点</strong></p>
<ol>
<li><p>应尽量避免在 <code>where</code> 子句中使用<code>!=</code>或<code>&lt;&gt;</code>操作符，否则将引擎放弃使用索引而进行全表扫描。</p>
</li>
<li><p>尽量避免在 <code>where</code> 子句中使用 <code>or</code> 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，如：<code>select id from t where num = 10 or num = 20</code>,用<code>union all</code>（union 和union all区别，尽量用union all）</p>
<pre><code> select id from t where num = 10   
 union all   
 select id from t where num = 20  
</code></pre></li>
<li><p>下面的查询也将导致全表扫描：<code>select id from t where name like ‘%abc%’</code><br>若要提高效率，可以考虑<code>全文检索</code>。</p>
</li>
<li><p><code>in</code> 和 <code>not in</code> 也要慎用，否则会导致全表扫描，如：<code>select id from t where num in(1,2,3)</code> </p>
</li>
</ol>
<p>对于连续的数值，能用 <code>between</code> 就不要用 <code>in</code> 了： </p>
<pre><code>select id from t where num between 1 and 3
</code></pre><ol>
<li>如果在 <code>where</code> 子句中使用参数，也会导致全表扫描。因为SQL只有在运行时才会解析局部变量，但优化程序不能将访问计划的选择推迟到运行时；它必须在编译时进行选择。然而，如果在编译时建立访问计划，变量的值还是未知的，因而无法作为索引选择的输入项。如下面语句将进行全表扫描：<code>select id from t where num = @num</code> </li>
</ol>
<p>可以改为强制查询使用索引： </p>
<pre><code>select id from t with(index(索引名)) where num = @num
</code></pre><ol>
<li>不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。如：select id from t where num / 2 = 100 </li>
</ol>
<p><code>select id from t where substring(name, 1 ,3) = ’abc’</code>查询name以abc开头的id列表</p>
<p>分别应改为: </p>
<pre><code>select id from t where num = 100 * 2   
select id from t where name like ‘abc%’ 
</code></pre><ol>
<li><p>在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使用，并且应尽可能的让字段顺序与索引顺序相一致。</p>
</li>
<li><p>很多时候用 exists 代替 in 是一个好的选择：select num from a where num in(select num from b) </p>
</li>
</ol>
<p>用下面的语句替换： </p>
<pre><code>select num from a where exists(select 1 from b where num = a.num)
</code></pre><ol>
<li><p>当结果集只有一行数据时使用<code>LIMIT 1</code></p>
</li>
<li><p>避免<code>SELECT *</code>，始终指定你需要的列</p>
<p>从表中读取越多的数据，查询会变得更慢。他增加了磁盘需要操作的时间，还是在数据库服务器与WEB服务器是独立分开的情况下。你将会经历非常漫长的网络延迟，仅仅是因为数据不必要的在服务器之间传输。</p>
</li>
<li><p>使用连接<code>JOIN</code>来代替子查询<code>Sub-Queries</code></p>
<p>连接<code>JOIN</code>.. 之所以更有效率一些，是因为MySQL不需要在内存中创建临时表来完成这个逻辑上的需要两个步骤的查询工作。</p>
</li>
<li><p>使用<code>ENUM</code>、<code>CHAR</code> 而不是<code>VARCHAR</code>，<font color="#e07878">使用合理的字段属性长度</font></p>
</li>
<li><p>尽可能的使用<code>NOT NULL</code></p>
</li>
<li><font color="#e07878">固定长度的表会更快</font>
</li>
<li><p>拆分大的<code>DELETE</code> 或<code>INSERT</code> 语句<br>如果你需要在一个在线的网站上去执行一个大的 DELETE 或 INSERT 查询，你需要非常小心，要避免你的操作让你的整个网站停止相应。因为这两个操作是会锁表的，表一锁住了，别的操作都进不来了。<br>Apache 会有很多的子进程或线程。所以，其工作起来相当有效率，而我们的服务器也不希望有太多的子进程，线程和数据库链接，这是极大的占服务器资源的事情，尤其是内存。<br>如果你把你的表锁上一段时间，比如30秒钟，那么对于一个有很高访问量的站点来说，这30秒所积累的访问进程/线程，数据库链接，打开的文件数，可能不仅仅会让你泊WEB服务Crash，还可能会让你的整台服务器马上掛了。<br>所以，如果你有一个大的处理，你定你一定把其拆分，使用 LIMIT 条件是一个好的方法。下面是一个示例：<br><code>DELETE FROM logs WHERE log_date &lt;= &#39;2009-11-01&#39; LIMIT 1000;</code></p>
</li>
<li><p>查询的列越小越快</p>
</li>
<li><p>永远为每张表设置一个ID<br>我们应该为数据库里的每张表都设置一个ID做为其主键，而且最好的是一个INT型的(推荐使用UNSIGNED)，并设置上自动增加的AUTO_INCREMENT标志。<br>就算是你 users 表有一个主键叫 “email”的字段，你也别让它成为主键。使用 VARCHAR 类型来当主键会使用得性能下降。另外，在你的程序中，你应该使用表的ID来构造你的数据结构。  </p>
</li>
<li><p>使用 ENUM 而不是 VARCHAR<br>ENUM 类型是非常快和紧凑的。在实际上，其保存的是 TINYINT，但其外表上显示为字符串。这样一来，用这个字段来做一些选项列表变得相当的完美。<br>如果你有一个字段，比如“性别”，“国家”，“民族”，“状态”或“部门”，你知道这些字段的取值是有限而且固定的，那么，你应该使用 ENUM 而不是 VARCHAR。  </p>
</li>
<li><p>把IP地址存成 UNSIGNED INT<br>很多程序员都会创建一个 VARCHAR(15) 字段来存放字符串形式的IP而不是整形的IP。如果你用整形来存放，只需要4个字节，并且你可以有定长的字段。而且，这会为你带来查询上的优势，尤其是当 你需要使用这样的WHERE条件：IP between ip1 and ip2。<br>我们必需要使用UNSIGNED INT，因为 IP地址会使用整个32位的无符号整形。<br>而你的查询，你可以使用 INET_ATON() 来把一个字符串IP转成一个整形，并使用 INET_NTOA() 把一个整形转成一个字符串IP。在PHP中，也有这样的函数 ip2long() 和 long2ip()。<br><code>UPDATE users SET ip = INET_ATON(&#39;{$_SERVER[&#39;REMOTE_ADDR&#39;]}&#39;) WHERE ...</code></p>
</li>
<li><p>垂直分割<br>“垂直分割”是一种把数据库中的表按列变成几张表的方法，这样可以降低表的复杂度和字段的数目，从而达到优化的目的。(以前，在银行做过项目，见过一张表有100多个字段，很恐怖)<br>示例一：在Users表中有一个字段是家庭地址，这个字段是可选字段，相比起，而且你在数据库操作的时候除了个 人信息外，你并不需要经常读取或是改写这个字段。那么，为什么不把他放到另外一张表中呢? 这样会让你的表有更好的性能，大家想想是不是，大量的时候，我对于用户表来说，只有用户ID，用户名，口令，用户角色等会被经常使用。小一点的表总是会有 好的性能。<br>示例二： 你有一个叫 “last_login” 的字段，它会在每次用户登录时被更新。但是，每次更新时会导致该表的查询缓存被清空。所以，你可以把这个字段放到另一个表中，这样就不会影响你对用户 ID，用户名，用户角色的不停地读取了，因为查询缓存会帮你增加很多性能。<br>另外，你需要注意的是，这些被分出去的字段所形成的表，你不会经常性地去Join他们，不然的话，这样的性能会比不分割时还要差，而且，会是极数级的下降。</p>
</li>
<li><p>选择正确的存储引擎<br>在 MySQL 中有两个存储引擎 MyISAM 和 InnoDB，每个引擎都有利有弊。酷壳以前文章《MySQL: InnoDB 还是 MyISAM?》讨论和这个事情。<br>MyISAM 适合于一些需要大量查询的应用，但其对于有大量写操作并不是很好。甚至你只是需要update一个字段，整个表都会被锁起来，而别的进程，就算是读进程都 无法操作直到读操作完成。另外，MyISAM 对于 SELECT COUNT(*) 这类的计算是超快无比的。<br>InnoDB 的趋势会是一个非常复杂的存储引擎，对于一些小的应用，它会比 MyISAM 还慢。他是它支持“行锁” ，于是在写操作比较多的时候，会更优秀。并且，他还支持更多的高级应用，比如：事务。  </p>
</li>
</ol>
<p><strong>Where条件</strong></p>
<p>在查询中，<code>WHERE</code>条件也是一个比较重要的因素，尽量少并且是合理的<code>where</code>条件是很重要的，尽量在多个条件的时候，把会提取尽量少数据量的条件放在前面，减少后一个<code>where</code>条件的查询时间。</p>
<p><strong>有些where条件会导致索引无效：</strong></p>
<p>where子句的查询条件里有<code>！=</code>，MySQL将无法使用索引。</p>
<p>where子句使用了Mysql函数的时候，索引将无效，比如：<code>select * from tb where left(name, 4) = ‘xxx’</code></p>
<p>使用LIKE进行搜索匹配的时候，这样索引是有效的：<code>select * from tbl1 where name like ‘xxx%’</code>，而<code>like ‘%xxx%’</code> 时索引无效</p>
<p><a href="http://blog.csdn.net/Mr__fang/article/details/40862865" target="_blank" rel="external">原文参考1</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzAxNzMwOTQ0NA%3D%3D&amp;mid=2653355115&amp;idx=1&amp;sn=3b2c862272d024f506caf7887c5ff6c0&amp;chksm=8035d600b7425f16e6b9aaa1322cfdc43d60e36d29474b32532dc82cdeca253e3baa774144bb" target="_blank" rel="external">原文参考2</a></p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>开发需要定期的删除表里一定时间以前的数据，SQL如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql &gt; delete from testtable WHERE biz_date &lt;= &apos;2017-08-21 00:00:00&apos;  AND status = 2  limit 500\G;</div></pre></td></tr></table></figure>
<p>前段时间在优化的时候，已经在相应的查询条件上加上了索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">KEY `idx_bizdate_st` (`biz_date`,`status`)</div></pre></td></tr></table></figure>
<p>但是实际执行的SQL依然非常慢，为什么呢，我们来一步步分析验证下</p>
<p><strong>分析</strong></p>
<p>表上的字段既然都有索引，那么按照之前的文章分析，是两个字段都可以走上索引的。如果有疑问，请参考文章 10分钟让你明白MySQL是如何利用索引的</p>
<p>既然能够利用索引，表的总大小也就是200M左右，那么为什么形成了慢查呢？</p>
<p>我们查看执行计划，去掉limit 后，发现他选择了走全表扫描。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">mysql &gt; desc  select * from testtable   WHERE biz_date &lt;= &apos;2017-08-21 00:00:00&apos;;</div><div class="line">+----+-------------+-----------+------+----------------+------+---------+------+--------+-------------+</div><div class="line">| id | select_type | table     | type | possible_keys  | key  | key_len | ref  | rows   | Extra       |</div><div class="line">+----+-------------+-----------+------+----------------+------+---------+------+--------+-------------+</div><div class="line">|  1 | SIMPLE      | testtable | ALL  | idx_bizdate_st | NULL | NULL    | NULL | 980626 | Using where |</div><div class="line">+----+-------------+-----------+------+----------------+------+---------+------+--------+-------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">-- 只查询biz_date</div><div class="line">-- 关键点：rows:980626;type:ALL </div><div class="line"></div><div class="line">mysql &gt; desc  select * from testtable   WHERE biz_date &lt;= &apos;2017-08-21 00:00:00&apos; and status = 2;</div><div class="line">+----+-------------+-----------+------+----------------+------+---------+------+--------+-------------+</div><div class="line">| id | select_type | table     | type | possible_keys  | key  | key_len | ref  | rows   | Extra       |</div><div class="line">+----+-------------+-----------+------+----------------+------+---------+------+--------+-------------+</div><div class="line">|  1 | SIMPLE      | testtable | ALL  | idx_bizdate_st | NULL | NULL    | NULL | 980632 | Using where |</div><div class="line">+----+-------------+-----------+------+----------------+------+---------+------+--------+-------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">-- 查询biz_date + status </div><div class="line">-- 关键点：rows:980632;type:ALL  </div><div class="line"></div><div class="line"></div><div class="line">mysql &gt; desc  select * from testtable   WHERE biz_date &lt;= &apos;2017-08-21 00:00:00&apos; and status = 2 limit 100;</div><div class="line">+----+-------------+-----------+-------+----------------+----------------+---------+------+--------+-----------------------+</div><div class="line">| id | select_type | table     | type  | possible_keys  | key            | key_len | ref  | rows   | Extra                 |</div><div class="line">+----+-------------+-----------+-------+----------------+----------------+---------+------+--------+-----------------------+</div><div class="line">|  1 | SIMPLE      | testtable | range | idx_bizdate_st | idx_bizdate_st | 6       | NULL | 490319 | Using index condition |</div><div class="line">+----+-------------+-----------+-------+----------------+----------------+---------+------+--------+-----------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">-- 查询biz_date + status+ limit </div><div class="line">-- 关键点：rows:490319;  </div><div class="line"></div><div class="line">mysql &gt; select count(*)  from testtable   WHERE biz_date &lt;= &apos;2017-08-21 00:00:00&apos; and status = 2;</div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|        0 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.34 sec)</div><div class="line"></div><div class="line"></div><div class="line">mysql &gt; select count(*)  from testtable   WHERE biz_date &lt;= &apos;2017-08-21 00:00:00&apos;;</div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|   970183 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.33 sec)</div><div class="line"></div><div class="line"></div><div class="line">mysql &gt; select count(*)  from testtable;</div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|   991421 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.19 sec)</div><div class="line"></div><div class="line"></div><div class="line">mysql &gt; select distinct biz_status from whwtestbuffer;</div><div class="line">+------------+</div><div class="line">| biz_status |</div><div class="line">+------------+</div><div class="line">|          1 |</div><div class="line">|          2 |</div><div class="line">|          4 |</div><div class="line">+------------+</div></pre></td></tr></table></figure>
<p>通过以上查询，我们可以发现如下几点问题：</p>
<p>通过 biz_date 预估出来的行数 和 biz_date + status=2 预估出来的行数几乎一样，为98w。<br>实际查询表 biz_date + status=2 一条记录都没有。<br>整表数据量达到了99万，MySQL发现通过索引扫描需要98w行（预估）<br>因此，MySQL通过统计信息预估的时候，发现需要扫描的索引行数几乎占到了整个表，放弃了使用索引，选择了走全表扫描。<br>那是不是他的统计信息有问题呢？我们重新收集了下表统计信息，发现执行计划的预估行数还是一样，猜测只能根据组合索引的第一个字段进行预估（待确定）</p>
<p>那我们试下直接强制让他走索引呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql &gt; select * from testtable   WHERE biz_date &lt;= &apos;2017-08-21 00:00:00&apos; and status = 2;</div><div class="line">Empty set (0.79 sec)</div><div class="line"></div><div class="line">mysql &gt; select * from testtable force index(idx_bizdate_st)  WHERE biz_date &lt;= &apos;2017-08-21 00:00:00&apos; and status = 2;</div><div class="line">Empty set (0.16 sec)</div></pre></td></tr></table></figure>
<p>我们发现，强制指定索引后，查询耗时和没有强制索引比较，的确执行速度快了很多，因为没有强制索引是全表扫描嘛！但是！依然非常慢！</p>
<p>那么还有什么办法去优化这个本来应该很快的查询呢？</p>
<p>大家应该都听说过要选择性好的字段放在组合索引的最前面？<br>是的，相对于status字段，biz_date 的选择性更加不错，那组合索引本身已经没有好调整了</p>
<p>那，能不能让他不要扫描索引的那么多范围呢？之前的索引模型中也说过，MySQL是通过索引去确定一个扫描范围，如果能够定位到尽可能小的范围，那是不是速度上会快很多呢？</p>
<p>并且业务逻辑上是定期删除一定日期之前的数据。所以逻辑上来说，每次删除都是只删除一天的数据，直接让SQL扫描一天的范围。那么我们就可以改写SQL啦!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql &gt; select * from testtable WHERE biz_date &gt;= &apos;2017-08-20 00:00:00&apos; and biz_date &lt;= &apos;2017-08-21 00:00:00&apos; and status = 2;</div><div class="line">Empty set (0.00 sec)</div><div class="line"></div><div class="line">mysql &gt; desc select * from testtable WHERE biz_date &gt;= &apos;2017-08-20 00:00:00&apos; and biz_date &lt;= &apos;2017-08-21 00:00:00&apos; and status = 2;</div><div class="line">+----+-------------+------------------+-------+----------------+----------------+---------+------+------+-----------------------+</div><div class="line">| id | select_type | table            | type  | possible_keys  | key            | key_len | ref  | rows | Extra                 |</div><div class="line">+----+-------------+------------------+-------+----------------+----------------+---------+------+------+-----------------------+</div><div class="line">|  1 | SIMPLE      | testtable        | range | idx_bizdate_st | idx_bizdate_st | 6       | NULL |  789 | Using index condition |</div><div class="line">+----+-------------+------------------+-------+----------------+----------------+---------+------+------+-----------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>rows降低了很多，乖乖的走了索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql &gt; desc select * from testtable WHERE biz_date &gt;= &apos;2017-08-20 00:00:00&apos; and biz_date &lt;= &apos;2017-08-21 00:00:00&apos; ;</div><div class="line">+----+-------------+------------------+-------+----------------+----------------+---------+------+------+-----------------------+</div><div class="line">| id | select_type | table            | type  | possible_keys  | key            | key_len | ref  | rows | Extra                 |</div><div class="line">+----+-------------+------------------+-------+----------------+----------------+---------+------+------+-----------------------+</div><div class="line">|  1 | SIMPLE      | testtable        | range | idx_bizdate_st | idx_bizdate_st | 5       | NULL | 1318 | Using index condition |</div><div class="line">+----+-------------+------------------+-------+----------------+----------------+---------+------+------+-----------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>即使没有status，也是肯定走索引啦</p>
<p>这个问题，我原本打算用hint，强制让他走索引，但是实际上强制走索引的执行时间并不能带来满意的效果。结合业务逻辑，来优化SQL，是最好的方式，也是终极法宝，一定要好好利用。</p>

      
      
        <div class="page-reward">
          <p><a href="javascript:void(0)" onclick="dashangToggle()" class="dashang">赏</a></p>
          <div class="hide_box"></div>
          <div class="shang_box">
            <a class="shang_close" href="javascript:void(0)" onclick="dashangToggle()">×</a>
            <div class="shang_tit">
              <p>如果文章对您有用请随意打赏！</p>
            </div>
            <div class="shang_payimg">
              <img src="/img/alipayimg.jpg" alt="扫码支持" title="扫一扫" />
            </div>
              <div class="pay_explain">谢谢支持！</div>
            <div class="shang_payselect">
              
                <div class="pay_item checked" data-id="alipay">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/alipay.jpg" alt="支付宝" /></span>
                </div>
              
              
                <div class="pay_item" data-id="wechat">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/weChat.jpg" alt="微信" /></span>
                </div>
              
            </div>
            <div class="shang_info">
              <p>打开<span id="shang_pay_txt">支付宝</span>扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
        </div>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
        <script type="text/javascript">
          $(".pay_item").click(function(){
            $(this).addClass('checked').siblings('.pay_item').removeClass('checked');
            var dataid=$(this).attr('data-id');
            $(".shang_payimg img").attr("src","/img/"+dataid+"img.jpg");
            $("#shang_pay_txt").text(dataid=="alipay"?"支付宝":"微信");
          });
          function dashangToggle(){
            
            $(".hide_box").fadeToggle();
            $(".shang_box").fadeToggle();
          }
        </script>
      
    </div>
    
  </div>
  
    
<div style="text-align:center;color: #ccc;font-size:14px;">
------ 本文结束 ------</div>
<br/>
<div style="border: 1px solid black">
<div style="margin-left:10px">
<span style="font-weight:blod">版权声明</span>
<img src="http://jet-han.gitee.io/img/copyright.png" >
<br/>
<p style="font-size: 10px;line-height: 30px"><a href="http://jet-han.gitee.io/" style="color:#258FC6">Jet's Blog</a> by <a href="http://jet-han.gitee.io/" style="color:#258FC6">Jet Han</a> is licensed under a <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" style="color:#258FC6">Creative Commons BY-NC-ND 4.0 International License</a>.<br/>
由<a href="http://jet-han.gitee.io" style="color:#258FC6"> jet han </a>创作并维护的<a href="http://jet-han.gitee.io" style="color:#258FC6"> jet </a>的博客采用<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" style="color:#258FC6">创作共用保留署名-非商业-禁止演绎4.0国际许可证</a>。<br/>
本文首发于<a href="http://jet-han.gitee.io/" style="color:#258FC6">Jet</a> 的博客（ <a href="http://jet-han.gitee.io/" style="color:#258FC6">http://jet-han.oschina.io/</a> ），版权所有，侵权必究。</p>
</div>

    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/05/29/mysql索引及查询优化/">mysql索引及查询优化</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Jet 的个人博客">Jet</a></p>
        <p><span>发布时间:</span>2017年05月29日 - 17时51分</p>
        <p><span>最后更新:</span>2017年05月29日 - 17时51分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/05/29/mysql索引及查询优化/" title="mysql索引及查询优化">https://jet-han.gitee.io/2017/05/29/mysql索引及查询优化/</a>
            <span class="copy-path" data-clipboard-text="原文: https://jet-han.gitee.io/2017/05/29/mysql索引及查询优化/　　作者: Jet" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2017/05/30/java常见排序算法/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          java常见排序算法
        
      </div>
    </a>
  
  
    <a href="/2017/05/28/java常用集合/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">java常用集合/容器</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

</div>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql调优"><span class="toc-number">1.</span> <span class="toc-text">mysql调优</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sql语句分类"><span class="toc-number">1.1.</span> <span class="toc-text">sql语句分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优化查询分析工具"><span class="toc-number">1.2.</span> <span class="toc-text">优化查询分析工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查询数据库性能"><span class="toc-number">1.2.1.</span> <span class="toc-text">查询数据库性能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#慢查询"><span class="toc-number">1.2.2.</span> <span class="toc-text">慢查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析查询语句"><span class="toc-number">1.2.3.</span> <span class="toc-text">分析查询语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析检测优化表"><span class="toc-number">1.2.4.</span> <span class="toc-text">分析检测优化表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Analyze-Table"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">Analyze Table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Checksum-Table"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">Checksum Table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Optimize-Table"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">Optimize Table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Check-Table"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">Check Table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Repair-Table"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">Repair Table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询高速缓存"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">查询高速缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询状态show-full-processlist"><span class="toc-number">1.2.4.7.</span> <span class="toc-text">查询状态show full processlist</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开启慢查询日志"><span class="toc-number">1.3.</span> <span class="toc-text">开启慢查询日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设置慢查询时间"><span class="toc-number">1.3.1.</span> <span class="toc-text">设置慢查询时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看是否打开慢查询日志记录"><span class="toc-number">1.3.2.</span> <span class="toc-text">查看是否打开慢查询日志记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#打开日志记录"><span class="toc-number">1.3.3.</span> <span class="toc-text">打开日志记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysqldumpslow-mysqlsla分析日志"><span class="toc-number">1.3.4.</span> <span class="toc-text">mysqldumpslow/mysqlsla分析日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mysqldumpslow"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">mysqldumpslow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mysqlsla慢查询分析工具"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">mysqlsla慢查询分析工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#explain分析查询"><span class="toc-number">1.4.</span> <span class="toc-text">explain分析查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引及查询优化"><span class="toc-number">1.5.</span> <span class="toc-text">索引及查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#索引的类型"><span class="toc-number">1.5.1.</span> <span class="toc-text">索引的类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#聚集索引"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">聚集索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#非聚集索引"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">非聚集索引</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-number">1.6.</span> <span class="toc-text">示例</span></a></li></ol></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>





<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
        <!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" style="width:90%;margin:5% auto 0 auto;background: #fff;padding: 0 12px;border-radius: 5px;" data-uid="MTAyMC8yOTg3NS82NDQw">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->

  



    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/05/30/java常见排序算法/" title="上一篇: java常见排序算法">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2017/05/28/java常用集合/" title="下一篇: java常用集合/容器">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/17/并发编程之synchronized与加锁机制/">并发编程之synchronized与加锁机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/12/jdk8💗特性/">jdk8💗特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/05/Cron/">Cron</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/30/Mybatis-MapperScannerConfigurer/">Mybatis-MapperScannerConfigurer</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/Mysql-SQL语句执行/">Mysql-SQL语句执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/Mysql-B-Tree索引/">Mysql-B-Tree索引</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/18/并发编程之CountDownLatch、CyclicBarrier和Semaphore/">并发编程之CountDownLatch、CyclicBarrier和Semaphore</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/14/Docker/">Docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/13/Spring中bean的生命周期/">Spring中bean的生命周期</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/08/设计模式/">设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/06/mysql数据库引擎/">mysql数据库引擎</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/06/并发编程之线程池ThreadPoolExecutor/">并发编程之线程池ThreadPoolExecutor</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/线程的实现方式/">线程的实现方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/jvm调优/">jvm调优</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/web-xml加载顺序/">web.xml加载顺序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/sping之IOC，AOP/">sping之IOC，AOP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/spring事务的传播属性和隔离级别/">spring事务的传播属性和隔离级别</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/乐观锁与悲观锁及应用举例/">乐观锁与悲观锁及应用举例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/mysql事务隔离级别/">mysql事务隔离级别</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/equals、-和hashCode/">equals、==和hashCode</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/28/HashMap工作原理/">HashMap工作原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/28/volatile用法/">volatile用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/28/java常量池/">java常量池</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/28/string比较之‘’equals‘’和‘’==‘’/">string比较之‘’equals‘’和‘’==‘’</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/26/spring Bean的作用域/">spring Bean的作用域</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/jvm内存模型/">jvm内存模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/18/并发编程-线程间协作/">并发编程-线程间协作</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/17/nginx安装与使用/">nginx安装与使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/16/solr安装与使用/">solr安装与使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/16/crontab安装及使用/">crontab安装及使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/15/大数据平台-ambari/">大数据平台-ambari</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/10/mysql配置详解/">mysql配置详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/09/google-cloud搭建vpn/">google-cloud搭建vpn</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/08/java-IO/">java-IO</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/02/github搭建个人maven仓库/">github搭建个人maven仓库</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/24/git/">git</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/19/linux常用操作命令/">linux常用操作命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/17/redis安装及使用/">redis安装及使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/15/mysql主从备份/">mysql主从备份</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/12/Java Generics/">Java Generics</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/Markdown-语法说明/">Markdown-语法说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/java常见排序算法/">java常见排序算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/29/mysql索引及查询优化/">mysql索引及查询优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/28/java常用集合/">java常用集合/容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/递归和迭代/">递归和迭代</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/StringBuilder和StringBuffer/">StringBuilder和StringBuffer</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/Hexo-NexT主题搭建个人博客/">Hexo-NexT主题搭建个人博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/07/java后端开发面试/">java后端开发面试</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2020 学海无涯
            </div>
            <div class="footer-right">
                <span class="author" itemprop="copyrightHolder">Powered By - Jet</span>
            </div>
        </div>
        

      <div class="total_count">
          本站共 <span id="busuanzi_value_site_pv"></span><span id="site_pv">次访问</span>
          您是第 <span id="busuanzi_value_site_uv"></span><span id="site_uv">个小伙伴</span>
          本页累计 <span id="busuanzi_value_page_pv"></span><span id="page_pv">次阅读</span>
          已运行 <span id="showDays"></span><span id="show_days">天</span>
      </div>
      <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
      </script>
      <script>
        var birthDay = new Date('05/24/2017');
        var now = new Date();
        var duration = now.getTime() - birthDay.getTime();
        var total= Math.floor(duration / (1000 * 60 * 60 * 24));
        document.getElementById('showDays').innerHTML=total;
      </script>
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>
<!-- 优效ssp<script src="http://s.6travel.com/titi126.js"></script>-->

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>






  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("{{theme.leancloud_visitors.app_id}}", "{{theme.leancloud_visitors.app_key}}");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


    <script type="text/javascript">
      window.onload = function(){
        document.getElementById("search").onclick = function(){
            console.log("search")
            search();
        }
      }
      function search(){
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
        (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
        e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','A1Pz-LKMXbrzcFg2FWi6','2.0.0');
      }
    </script>


    <script type="text/javascript">
   document.oncontextmenu = function(){
     return false;
   }
   document.onkeydown = function(){
    if (event.ctrlKey && window.event.keyCode==67){
    return false;
    }
    if ((window.event.altKey)&& 
     ((window.event.keyCode==37)||   
      (window.event.keyCode==39))){alert("请访问主页"); 
    event.returnValue=false; 
    } 
if ((event.keyCode==8)||(event.keyCode==116)){//屏蔽 F5 刷新键 
    event.keyCode=0; 
    event.returnValue=false; 
    } 
if ((event.ctrlKey)&&(event.keyCode==78)){   //屏蔽 Ctrl+n 
    event.returnValue=false; 
    } 
if ((event.shiftKey)&&(event.keyCode==121)){ //屏蔽 shift+F10 
    event.returnValue=false; 
    }
if (event.keyCode==123){ //屏蔽 F12 
    event.returnValue=false;
    }
   }
  document.body.oncopy = function (){
   return false;
  }
  //不建议连选中文本都不行
  document.onselectstart = function(){
  //return false;
  }
    </script>


  </div>
</body>
</html>